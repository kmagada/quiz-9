name: Docker CI

on:
    push:
        branches: [ main, master ]
    pull_request:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up QEMU (for multi-arch support)
              uses: docker/setup-qemu-action@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Build Docker image
              uses: docker/build-push-action@v4
              with:
                context: .
                file: ./Dockerfile
                push: false
                tags: test-image:ci

            - name: Run tests inside container
            run: |
                    # Try common test commands inside the built image.
                    # Edit this block to match your project's test command.
                    docker run --rm test-image:ci sh -c "\
                        if command -v pytest >/dev/null 2>&1; then \
                            pytest -q; \
                        elif [ -f Makefile ]; then \
                            make test; \
                        elif [ -f package.json ] && command -v npm >/dev/null 2>&1; then \
                            npm test --silent; \
                        else \
                            echo 'No test command detected in container'; exit 1; \
                        fi"